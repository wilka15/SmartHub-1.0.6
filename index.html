<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartHub AI v1.0.3</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    transition: .3s;
}
body.dark { background: #0b0f19; color: white; }
body.light { background: #f3f3f3; color: #111; }

.layout {
    display: flex;
    height: 100vh;
}

/* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ */
.chat-panel {
    flex: 3;
    padding: 20px;
    display: flex;
    flex-direction: column;
}
.title {
    text-align: center;
    margin-top: 0;
    text-shadow: 0 0 10px #00d4ff;
}
#chat {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
}
.msg {
    display: flex;
    gap: 10px;
    margin-bottom: 12px;
}
.msg-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
}
.bubble {
    padding: 10px 14px;
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    max-width: 75%;
}
.msg.user .bubble { background: #00d4ff; color: #002; margin-left: auto; }
.msg.ai .bubble { background: rgba(0,255,170,0.3); }

.input-area {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}
input {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-size: 16px;
}
button {
    padding: 12px 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    transition: .2s;
}
button:hover { transform: scale(1.07); }

.version {
    margin-top: 10px;
    opacity: .6;
    text-align: center;
}

/* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ */
.settings-panel {
    flex: 1;
    background: rgba(255,255,255,0.07);
    backdrop-filter: blur(12px);
    padding: 20px;
    display: none;
    flex-direction: column;
}
.settings-panel.show { display: flex; }

.settings-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 12px;
    border-radius: 50%;
    background: #00d4ff;
}

/* –¢–æ–≥–≥–ª–µ—Ä */
.switch-label {
    margin-top: 10px;
    display: block;
}
.switch {
    position: relative;
    width: 50px; height: 24px;
    margin-top: 5px;
}
.switch input { display: none; }
.slider {
    position: absolute;
    cursor: pointer;
    background: #ccc;
    border-radius: 24px;
    top: 0; left: 0; right: 0; bottom: 0;
}
.slider:before {
    content: "";
    position: absolute;
    width: 20px; height: 20px;
    background: white; border-radius: 50%;
    top: 2px; left: 2px;
    transition: .3s;
}
input:checked + .slider { background: #00d4ff; }
input:checked + .slider:before { transform: translateX(26px); }

.avatar-select { margin-top: 10px; }
.avatar-preview {
    width: 70px; height: 70px;
    border-radius: 50%;
    border: 3px solid #00d4ff;
    margin-bottom: 10px;
}
.avatar-options {
    display: flex; gap: 10px;
}
.avatar-option {
    width: 55px; height: 55px;
    border-radius: 50%;
    opacity: .7; cursor: pointer;
    transition: .2s;
    border: 2px solid transparent;
}
.avatar-option:hover {
    opacity: 1;
    transform: scale(1.1);
    border-color: #00d4ff;
}
.close-btn {
    margin-top: auto;
    padding: 12px;
    background: #ff3b3b;
}
</style>

</head>
<body class="dark">

<div class="layout">

    <!-- –ß–ê–¢ -->
    <div class="chat-panel">
        <h2 class="title">SmartHub AI</h2>

        <div id="chat"></div>

        <div class="input-area">
            <input id="userInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
            <button onclick="sendMessage()">‚û§</button>
            <button onclick="voiceInput()">üé§</button>
            <button onclick="speakLast()">üîä</button>
        </div>

        <div class="version">SmartHub AI v1.0.3</div>
    </div>

    <!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
    <div class="settings-panel" id="settingsPanel">
        <h3>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

        <label class="switch-label">–¢–µ–º–∞</label>
        <label class="switch">
            <input type="checkbox" id="themeSwitch" onchange="toggleTheme()">
            <span class="slider"></span>
        </label>

        <hr>

        <label class="switch-label">–ì–æ–ª–æ—Å</label>
        <select id="voiceSelect">
            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
        </select>

        <hr>

        <label class="switch-label">–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
        <div class="avatar-select">
            <img id="avatarPreview" src="user1.png" class="avatar-preview">
            <div class="avatar-options">
                <img src="user1.png" class="avatar-option" onclick="setUserAvatar('user1.png')">
                <img src="user2.png" class="avatar-option" onclick="setUserAvatar('user2.png')">
                <img src="user3.png" class="avatar-option" onclick="setUserAvatar('user3.png')">
            </div>
        </div>

        <hr>

        <button class="close-btn" onclick="toggleSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <button class="settings-btn" onclick="toggleSettings()">‚ò∞</button>

</div>

<script>
const API_URL = "https://openai-proxy-ucgy.onrender.com/v1/responses";

let lastAIMessage = "";
let userAvatar = localStorage.getItem("userAvatar") || "user1.png";
let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");

/* ---------- –û–¢–ü–†–ê–í–ö–ê ---------- */
async function sendMessage() {
    const input = document.getElementById("userInput");
    const text = input.value.trim();
    if (!text) return;
    input.value = "";

    addMessage(text, "user");

    const response = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            model: "gpt-4o-mini",
            input: text
        })
    });

    const data = await response.json();
    const ai = data.output[0].content[0].text;

    addMessage(ai, "ai");
    lastAIMessage = ai;
}

/* ---------- –ß–ê–¢ + –ü–ê–ú–Ø–¢–¨ ---------- */
function addMessage(text, role) {
    const chat = document.getElementById("chat");

    const wrap = document.createElement("div");
    wrap.className = "msg " + role;

    const avatar = document.createElement("img");
    avatar.className = "msg-avatar";
    avatar.src = role === "user" ? userAvatar : "avatar-ai.png";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    wrap.appendChild(avatar);
    wrap.appendChild(bubble);
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;

    chatHistory.push({
        text,
        role,
        avatar: avatar.src
    });
    localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
}

/* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ */
function loadChat() {
    chatHistory.forEach(msg => {
        const wrap = document.createElement("div");
        wrap.className = "msg " + msg.role;

        const avatar = document.createElement("img");
        avatar.src = msg.avatar;
        avatar.className = "msg-avatar";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = msg.text;

        wrap.appendChild(avatar);
        wrap.appendChild(bubble);

        document.getElementById("chat").appendChild(wrap);
    });
}

/* ---------- –ì–æ–ª–æ—Å ---------- */
function speakLast() {
    if (!lastAIMessage) return;
    const utter = new SpeechSynthesisUtterance(lastAIMessage);
    utter.lang = "ru-RU";

    const v = document.getElementById("voiceSelect").value;
    const voices = speechSynthesis.getVoices();
    utter.voice = voices.find(x => x.name.toLowerCase().includes(v)) || null;

    speechSynthesis.speak(utter);
}

/* ---------- –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ ---------- */
function voiceInput() {
    const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!Rec) return alert("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏");

    const rec = new Rec();
    rec.lang = "ru-RU";
    rec.start();

    rec.onresult = e => {
        document.getElementById("userInput").value =
            e.results[0][0].transcript;
    };
}

/* ---------- –¢–µ–º–∞ ---------- */
function toggleTheme() {
    document.body.classList.toggle("light");
    document.body.classList.toggle("dark");
}

/* ---------- –ú–µ–Ω—é ---------- */
function toggleSettings() {
    document.getElementById("settingsPanel").classList.toggle("show");
}

/* ---------- –ê–≤–∞—Ç–∞—Ä ---------- */
function setUserAvatar(file) {
    userAvatar = file;
    localStorage.setItem("userAvatar", file);
    document.getElementById("avatarPreview").src = file;
}

/* ---------- –°–¢–ê–†–¢ ---------- */
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("avatarPreview").src = userAvatar;
    loadChat();
});
</script>

</body>
</html>
