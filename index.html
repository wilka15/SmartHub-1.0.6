<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SmartHub AI ‚Äî —É–ª—É—á—à–µ–Ω–Ω—ã–π</title>
<meta name="description" content="SmartHub AI ‚Äî —á–∞—Ç —Å –≥–æ–ª–æ—Å–æ–º, –æ–∑–≤—É—á–∫–æ–π, —Ç–µ–º–∞–º–∏, –∞–≤–∞—Ç–∞—Ä–∞–º–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏—Å—Ç–æ—Ä–∏–∏" />
<style>
  :root{
    --bg-1:#071022; --bg-2:#0b1630; --card:rgba(255,255,255,0.04);
    --accent:#00d4ff; --accent-2:#00ff9e; --muted:#9aa4b2; --glass: rgba(255,255,255,0.03);
    --radius:14px; --glass-border: rgba(255,255,255,0.05);
  }

  /* Light theme variables */
  .light {
    --bg-1: #f5f8fb; --bg-2: #ffffff; --card: rgba(10,16,24,0.04);
    --accent: #0b63d6; --accent-2:#06b6d4; --muted:#475569; --glass: rgba(0,0,0,0.03);
    color: #071022;
  }

  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{
    background: linear-gradient(135deg,var(--bg-1),var(--bg-2));
    display:flex;align-items:center;justify-content:center;padding:28px;transition:background .35s ease,color .35s ease;
    color: #e6eef6;
  }

  .app {
    width:100%; max-width:960px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:20px; padding:18px; box-shadow: 0 10px 40px rgba(2,6,23,0.6); border:1px solid var(--glass-border);
    display:grid; grid-template-columns: 1fr 320px; gap:18px; align-items:start;
  }

  @media (max-width:900px){ .app{ grid-template-columns: 1fr; } }

  header.app-head{ grid-column:1 / -1; display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:4px;}
  .brand { display:flex; gap:12px; align-items:center; }
  .logo { width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2)); display:flex;align-items:center;justify-content:center;font-weight:700;color:#032; box-shadow:0 8px 30px rgba(0,212,255,0.12);}
  h1{font-size:18px;margin:0}
  .sub{color:var(--muted);font-size:13px}

  /* CHAT PANEL */
  .panel{ background:var(--card); padding:16px; border-radius:var(--radius); border:1px solid var(--glass-border); display:flex;flex-direction:column; min-height:520px; }
  #chat { flex:1; overflow:auto; padding:12px; border-radius:10px; background: linear-gradient(180deg, rgba(0,0,0,0.05), rgba(255,255,255,0.01)); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); display:flex; flex-direction:column; gap:10px; }
  .msg { display:flex; gap:10px; align-items:flex-start; max-width:86%; opacity:0; transform:translateY(8px); animation: msgIn .28s forwards; }
  @keyframes msgIn { to { opacity:1; transform:none; } }

  .msg.user { margin-left:auto; flex-direction:row-reverse; }
  .bubble { padding:10px 14px; border-radius:12px; background: rgba(255,255,255,0.02); color:inherit; line-height:1.35; box-shadow: 0 6px 18px rgba(2,6,23,0.4); }
  .msg.user .bubble { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#002; }

  .avatar { width:40px;height:40px;border-radius:50%;flex:0 0 40px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#012; background:rgba(255,255,255,0.05); }
  .msg.ai .avatar { background:linear-gradient(90deg,#8affc1,#00d4ff); color:#022; box-shadow:0 6px 18px rgba(0,212,255,0.08); }
  .meta { font-size:12px;color:var(--muted); margin-top:6px; }

  /* input area */
  .controls { display:flex; gap:10px; margin-top:12px; align-items:center; }
  .input { flex:1; display:flex; gap:10px; align-items:center; background:transparent; border-radius:12px; padding:8px; border:1px solid var(--glass-border); }
  input#userInput { flex:1; border:0; outline:0; background:transparent; color:inherit; padding:10px; font-size:16px; }
  .btn { padding:10px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:700; background:var(--accent); color:#001; transition:transform .12s ease,box-shadow .12s ease; }
  .btn:active{ transform:scale(.98); }
  .btn.secondary{ background:transparent; border:1px solid var(--glass-border); color:var(--muted); font-weight:600;}
  .small { padding:8px 10px; font-size:14px; border-radius:8px; }

  /* right column */
  .sidebar { background:var(--card); padding:16px; border-radius:var(--radius); border:1px solid var(--glass-border); display:flex; flex-direction:column; gap:12px; min-height:520px; }
  .row { display:flex; gap:8px; align-items:center; justify-content:space-between; }

  .switch { display:inline-flex; align-items:center; gap:8px; }
  .toggle { width:46px; height:26px; background:rgba(255,255,255,0.04); border-radius:999px; position:relative; cursor:pointer; border:1px solid rgba(255,255,255,0.03); }
  .knob { position:absolute; top:3px; left:3px; width:20px; height:20px; background:white; border-radius:50%; transition:left .18s ease, background .18s; }
  .light .knob { left:23px; background:#071022; }

  .muted { color:var(--muted); font-size:13px; }

  /* loading overlay */
  .overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:9999; opacity:0; pointer-events:none; transition:opacity .2s ease; }
  .overlay.show { opacity:1; pointer-events:all; }
  .loader { width:90px;height:90px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); display:flex;align-items:center;justify-content:center; flex-direction:column; border:1px solid rgba(255,255,255,0.03); }
  .dot { width:12px;height:12px;border-radius:50%; background:var(--accent); margin:6px; animation: pulse 1s infinite; }
  @keyframes pulse { 0%{transform:scale(.8);opacity:.6}50%{transform:scale(1.2);opacity:1}100%{transform:scale(.8);opacity:.6} }

  footer{ grid-column:1 / -1; text-align:center; color:var(--muted); font-size:13px; margin-top:6px; }
</style>
</head>
<body>
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="loader">
      <div style="font-weight:700;margin-bottom:8px">–ü–æ–¥–æ–∂–¥–∏—Ç–µ...</div>
      <div style="display:flex"><div class="dot"></div><div class="dot" style="animation-delay:.2s"></div><div class="dot" style="animation-delay:.4s"></div></div>
    </div>
  </div>

  <main class="app" id="app">
    <header class="app-head">
      <div class="brand">
        <div class="logo">SH</div>
        <div>
          <h1>SmartHub AI</h1>
          <div class="sub">–ì–æ–ª–æ—Å, –æ–∑–≤—É—á–∫–∞, –∏—Å—Ç–æ—Ä–∏—è, —Ç–µ–º—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <div class="muted">–¢–µ–º–∞</div>
        <div class="switch" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
          <div id="themeToggle" class="toggle" role="button" aria-pressed="false"><div class="knob"></div></div>
        </div>
      </div>
    </header>

    <section class="panel">
      <div id="chat" aria-live="polite"></div>

      <div class="controls" style="margin-top:14px">
        <div class="input" role="group" aria-label="–í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è">
          <input id="userInput" autocomplete="off" placeholder="–°–ø—Ä–æ—Å–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å... (–∏–ª–∏ –Ω–∞–∂–º–∏ üé§)" />
        </div>

        <button class="btn small" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="btn small" id="micBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
        <button class="btn secondary small" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
        <button class="btn secondary small" id="stopBtn">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–∑–≤—É—á–∫—É</button>
        <div class="muted" style="margin-left:auto">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</div>
      </div>
    </section>

    <aside class="sidebar">
      <div>
        <div style="font-weight:700">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
        <div class="muted" style="margin-top:6px">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —á–∞—Ç–∞ SmartHub</div>
      </div>

      <div class="row">
        <div>
          <div style="font-weight:700">–ú–æ–¥–µ–ª—å</div>
          <div class="muted" style="font-size:13px;margin-top:6px">gpt-4o-mini (—á–µ—Ä–µ–∑ —Ç–≤–æ–π –ø—Ä–æ–∫—Å–∏)</div>
        </div>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:700">–ò—Å—Ç–æ—Ä–∏—è</div>
        <div id="historyList" class="muted" style="margin-top:8px; max-height:240px; overflow:auto"></div>
      </div>

      <div style="margin-top:auto">
        <div class="muted">–í–µ—Ä—Å–∏—è</div>
        <div style="font-weight:700;margin-top:6px">SmartHub v1.2</div>
      </div>
    </aside>

    <footer>¬© <span id="year"></span> ‚Äî SmartHub</footer>
  </main>

<script>
/* ------------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ------------- */
const API_URL = "https://openai-proxy-22.onrender.com/v1/responses";
const STORAGE_KEY = "smarthub_history_v1";

/* ------------- UI —ç–ª–µ–º–µ–Ω—Ç—ã ------------- */
const chatEl = document.getElementById('chat');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const clearBtn = document.getElementById('clearBtn');
const stopBtn = document.getElementById('stopBtn');
const overlay = document.getElementById('overlay');
const historyList = document.getElementById('historyList');
const userInput = document.getElementById('userInput');
const themeToggle = document.getElementById('themeToggle');
const appEl = document.getElementById('app');

/* ------------- –°–æ—Å—Ç–æ—è–Ω–∏–µ ------------- */
let speakingUtterance = null;
let isWaiting = false;
let history = []; // {role:'user'|'ai', text:'...'}

/* ------------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ------------- */
document.getElementById('year').textContent = new Date().getFullYear();
loadHistory();
renderHistoryList();
applySavedTheme();

/* ------------- –°–ª—É—à–∞—Ç–µ–ª–∏ ------------- */
sendBtn.addEventListener('click', () => { sendMessage(); });
userInput.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) sendMessage(); });
micBtn.addEventListener('click', voiceInput);
clearBtn.addEventListener('click', clearChat);
stopBtn.addEventListener('click', stopSpeech);
themeToggle.addEventListener('click', toggleTheme);

/* ------------- –§—É–Ω–∫—Ü–∏–∏ UI ------------- */
function showOverlay(show){
  if(show) overlay.classList.add('show'); else overlay.classList.remove('show');
}

function setWaiting(v){
  isWaiting = v;
  sendBtn.disabled = v;
  micBtn.disabled = v;
  if(v) showOverlay(true); else showOverlay(false);
}

/* –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ */
function addMessage(text, role, save=true){
  const wrap = document.createElement('div');
  wrap.className = `msg ${role}`;
  const avatar = document.createElement('div');
  avatar.className = 'avatar';
  avatar.textContent = role === 'user' ? '–í—ã' : 'AI';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  wrap.appendChild(avatar);
  wrap.appendChild(bubble);
  chatEl.appendChild(wrap);
  chatEl.scrollTop = chatEl.scrollHeight;
  if(save){ history.push({role, text}); persistHistory(); renderHistoryList(); }
}

/* —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø—Ä–∞–≤–∞ */
function renderHistoryList(){
  historyList.innerHTML = '';
  for(let i = history.length-1; i>=0; i--){
    const it = history[i];
    const el = document.createElement('div');
    el.style.padding = '8px 6px';
    el.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
    el.innerHTML = `<div style="font-weight:700">${it.role === 'user' ? '–í—ã' : 'AI'}</div><div class="muted" style="margin-top:6px">${truncate(it.text,120)}</div>`;
    el.title = it.text;
    historyList.appendChild(el);
  }
}

/* —Å–æ—Ö—Ä–∞–Ω—è–µ–º/—á–∏—Ç–∞–µ–º */
function persistHistory(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); }catch(e){ console.warn(e); } }
function loadHistory(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ history = JSON.parse(raw); history.forEach(h=> addMessage(h.text, h.role, false)); } }catch(e){ console.warn(e); } }

/* –æ—á–∏—Å—Ç–∫–∞ */
function clearChat(){
  if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) return;
  history = []; persistHistory();
  chatEl.innerHTML = ''; renderHistoryList();
}

/* —É—Ç–∏–ª–∏—Ç–∞ */
function truncate(s, n){ if(!s) return ''; return s.length>n ? s.slice(0,n-1)+'‚Ä¶' : s; }

/* ------------- –ì–æ–ª–æ—Å (–≤–≤–æ–¥) ------------- */
function voiceInput(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){ alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'); return; }
  const rec = new SpeechRecognition();
  rec.lang = 'ru-RU';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  setWaiting(true);
  rec.start();
  micBtn.style.background = '#ffa200';
  rec.onresult = (e) => {
    const txt = e.results[0][0].transcript;
    userInput.value = txt;
  };
  rec.onerror = (e) => { console.warn('rec error', e); alert('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞'); setWaiting(false); micBtn.style.background=''; }
  rec.onend = () => { micBtn.style.background=''; setWaiting(false); }
}

/* ------------- –ì–æ–ª–æ—Å (–æ–∑–≤—É—á–∫–∞) ------------- */
function speak(text){
  try{
    stopSpeech();
    const synth = window.speechSynthesis;
    if(!synth) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ru-RU';
    u.rate = 1;
    u.pitch = 1;
    speakingUtterance = u;
    synth.speak(u);
    u.onend = () => { speakingUtterance = null; }
  }catch(e){ console.warn(e); }
}
function stopSpeech(){
  try{ const s = window.speechSynthesis; if(s && s.speaking){ s.cancel(); speakingUtterance = null; } }catch(e){ console.warn(e); }
}

/* ------------- –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ------------- */
async function sendMessage(){
  if(isWaiting) return;
  const text = userInput.value.trim();
  if(!text) return;
  addMessage(text, 'user'); userInput.value = '';
  setWaiting(true);
  try{
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ model: 'gpt-4o-mini', input: text })
    });

    // –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON –∏–ª–∏ —Å—Ç–∞—Ç—É—Å != 200, –æ–±—Ä–∞–±–æ—Ç–∞–µ–º
    let data;
    try { data = await res.json(); } catch(e) { addMessage('–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'ai'); setWaiting(false); return; }

    if(!data || !data.output){
      console.warn('Response body:', data);
      addMessage('–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç', 'ai');
      setWaiting(false); return;
    }

    // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫
    let aiText = '';
    try{
      const out = data.output[0];
      // output content –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤; –∏—â–µ–º –ø–µ—Ä–≤—ã–π —Å–æ–¥–µ—Ä–∂–∞—â–∏–π text
      if(out && out.content && Array.isArray(out.content)){
        for(const c of out.content){
          if(typeof c.text === 'string' && c.text.trim()){ aiText += (aiText ? '\n' : '') + c.text; }
          else if(typeof c === 'string' && c.trim()){ aiText += (aiText ? '\n' : '') + c; }
        }
      } else if(typeof out === 'string') aiText = out;
      else if(data?.output_text) aiText = data.output_text;
    }catch(e){ console.warn(e); }

    if(!aiText) aiText = JSON.stringify(data).slice(0,400);

    addMessage(aiText, 'ai');
    speak(aiText);

  }catch(err){
    console.error(err);
    addMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ø—Ä–æ–∫—Å–∏/—Å–µ—Ä–≤–µ—Ä–æ–º', 'ai');
  } finally {
    setWaiting(false);
  }
}

/* ------------- –¢–µ–º–∞ ------------- */
function applySavedTheme(){
  const t = localStorage.getItem('smarthub_theme') || 'dark';
  if(t === 'light') document.documentElement.classList.add('light'); else document.documentElement.classList.remove('light');
  themeToggle.setAttribute('aria-pressed', t==='light' ? 'true' : 'false');
  themeToggle.querySelector('.knob').style.left = t==='light' ? '23px' : '3px';
}
function toggleTheme(){
  const isLight = document.documentElement.classList.toggle('light');
  localStorage.setItem('smarthub_theme', isLight ? 'light' : 'dark');
  themeToggle.querySelector('.knob').style.left = isLight ? '23px' : '3px';
  themeToggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');
}

/* ------------- –£–¥–æ–±—Å—Ç–≤–∞ ------------- */
function persistHistory(){} // –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ä–∞–Ω–µ–µ; –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤—ã—à–µ; (noop placeholder if overwritten)
persistHistory = function(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(history)); }catch(e){console.warn(e);} };
loadHistory = function(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw){ history = JSON.parse(raw); chatEl.innerHTML=''; history.forEach(h=> addMessage(h.text, h.role, false)); } }catch(e){ console.warn(e); } };

/* Ensure overlay is hidden initially */
showOverlay(false);

/* render history list after load */
renderHistoryList();
</script>
</body>
</html>
