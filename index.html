<script>
/* URL твоего прокси */
const API_URL = "https://smarthub-proxy.onrender.com/v1/responses";

/* Хранение последнего текста */
let lastAIMessage = "";
let speakingUtterance = null;

/* Настройки */
let voiceGender = "female"; // по умолчанию: женский голос

/* ---------- МЕНЮ НАСТРОЕК ---------- */
function toggleSettings(){
    let menu = document.getElementById("settingsMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function setVoice(gender){
    voiceGender = gender;
    alert("Голос изменён: " + (gender === "female" ? "Женский" : "Мужской"));
}

/* ---------- ТЕКСТ + АВАТАРЫ + ТИПИНГ ---------- */
function addMessage(text, role, typing=false) {
    const chat = document.getElementById("chat");

    const wrap = document.createElement("div");
    wrap.className = "msg " + role;

    const avatar = document.createElement("div");
    avatar.className = "avatar";

    const img = document.createElement("img");
    img.src = role === "user" ? "avatar-user.png" : "avatar-ai.png";
    avatar.appendChild(img);

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    if (typing && role === "ai") {
        bubble.innerHTML = `
            <div class="typing">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>`;
        avatar.classList.add("speaking");
    } else {
        bubble.textContent = text;
    }

    wrap.appendChild(avatar);
    wrap.appendChild(bubble);
    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;

    return {wrap, avatar, bubble};
}

/* ---------- ПЕЧАТНАЯ АНИМАЦИЯ ---------- */
async function typeText(element, text, speed = 25){
    element.textContent = "";
    for (let i = 0; i < text.length; i++){
        element.textContent += text[i];
        await new Promise(r => setTimeout(r, speed));
    }
}

/* ---------- ОТПРАВКА СООБЩЕНИЯ ---------- */
async function sendMessage() {
    const input = document.getElementById("userInput");
    const text = input.value.trim();
    if (!text) return;

    addMessage(text, "user");
    input.value = "";

    // Индикатор печати
    const t = addMessage("", "ai", true);

    const res = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            model: "gpt-4o-mini",
            input: text
        })
    });

    const data = await res.json();

    t.avatar.classList.remove("speaking");
    t.bubble.innerHTML = "";

    const ai = data.output[0].content[0].text;
    lastAIMessage = ai;

    // печать текста по буквам
    await typeText(t.bubble, ai, 18);
}

/* ---------- ОЗВУЧКА ---------- */
function speakLast(){
    if (!lastAIMessage) return alert("Нет текста для озвучки");
    speak(lastAIMessage);
}

function speak(text){
  stopSpeech();

  const synth = window.speechSynthesis;
  if(!synth) return;

  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ru-RU';
  u.rate = 1;
  u.pitch = voiceGender === "female" ? 1 : 0.3;

  speakingUtterance = u;
  synth.speak(u);

  u.onend = () => { speakingUtterance = null; };
}

function stopSpeech(){
  const s = window.speechSynthesis;
  if(s && s.speaking){
      s.cancel();
      speakingUtterance = null;
  }
}

/* ---------- ГОЛОСОВОЙ ВВОД ---------- */
function voiceInput() {
    const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!Rec) return alert("Браузер не поддерживает распознавание речи");

    const rec = new Rec();
    rec.lang = "ru-RU";
    rec.start();

    document.getElementById("micBtn").style.background = "#ffa200";

    rec.onresult = e => {
        document.getElementById("userInput").value = e.results[0][0].transcript;
    };

    rec.onend = () => {
        document.getElementById("micBtn").style.background = "#ff3b3b";
    };
}
</script>
