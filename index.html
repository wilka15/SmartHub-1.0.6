<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SmartHub AI v1.0.5</title>

  <!-- –ö—Ä–∞—Å–∏–≤—ã–π —à—Ä–∏—Ñ—Ç –∏–∑ Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #0b0f19;
      --text-dark: #eef;
      --bg-light: #f3f3f3;
      --text-light: #111;
      --panel-dark: rgba(255,255,255,0.04);
      --panel-light: rgba(0,0,0,0.04);
      --accent: #00d4ff;
      --font-family-base: 'Inter', system-ui, Arial, sans-serif;
    }
    body {
      margin: 0;
      font-family: var(--font-family-base);
      background: var(--bg-dark);
      color: var(--text-dark);
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    .app {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      padding: 20px;
      box-sizing: border-box;
      height: 100vh;
      align-items: stretch;
    }

    .panel {
      background: linear-gradient(180deg, var(--panel-dark), var(--panel-dark));
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    body.light .panel {
      background: linear-gradient(180deg, var(--panel-light), var(--panel-light));
    }

    .header {
      text-align: center;
      font-weight: 700;
      font-size: 24px;
      color: var(--accent);
    }

    .chat-window {
      background: var(--panel-dark);
      border-radius: 10px;
      padding: 12px;
      flex: 1;
      overflow-y: auto;
      min-height: 120px;
    }
    body.light .chat-window {
      background: var(--panel-light);
    }

    .msg {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .msg .avatar {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      flex: 0 0 54px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    .bubble {
      padding: 12px 14px;
      border-radius: 12px;
      max-width: 78%;
      line-height: 1.35;
      background: rgba(255,255,255,0.04);
      position: relative;
      overflow: hidden;
    }
    .msg.user { justify-content: flex-end; flex-direction: row-reverse; }
    .msg.user .bubble {
      background: var(--accent);
      color: #002;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è ¬´–ø–µ—á–∞—Ç–∏¬ª –¥–ª—è ai-–æ—Ç–≤–µ—Ç–æ–≤ */
    .bubble.typing::after {
      content: '';
      display: inline-block;
      width: 4px;
      height: 1em;
      background: var(--accent);
      margin-left: 4px;
      animation: blink 1s infinite;
      vertical-align: bottom;
    }
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .bubble.text-reveal {
      animation: revealText 0.5s ease-out forwards;
    }
    @keyframes revealText {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .input-row input[type="text"] {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      background: rgba(0,0,0,0.2);
      color: inherit;
      outline: none;
    }
    .icon-btn, .small-btn {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 10px;
    }
    .icon-btn {
      width: 48px;
      height: 48px;
      background: var(--accent);
      color: #002;
      font-weight: bold;
    }
    .small-btn {
      width: 44px;
      height: 44px;
      background: #222;
      color: #ddd;
    }

    .settings {
      background: linear-gradient(180deg, var(--panel-dark), var(--panel-dark));
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    body.light .settings {
      background: linear-gradient(180deg, var(--panel-light), var(--panel-light));
    }

    .settings h3 { margin: 0; color: var(--accent); }
    .field { display: flex; flex-direction: column; gap: 8px; font-size: 14px; }
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 6px;
      font-size: 13px;
      opacity: .85;
    }
    .version { margin-left: auto; }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <div class="header">SmartHub AI</div>
      <div id="chat" class="chat-window" aria-live="polite" role="log"></div>
      <div class="input-row">
        <input id="userInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
        <button class="icon-btn" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        <button class="small-btn" id="micBtn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥">üé§</button>
        <button class="small-btn" id="speakBtn" title="–û–∑–≤—É—á–∏—Ç—å">üîä</button>
      </div>
      <div class="footer">
        <div class="version">SmartHub AI v1.0.5</div>
      </div>
    </div>

    <aside class="settings" id="settingsPanel">
      <h3>‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="field">
        <label><input type="checkbox" id="themeSwitch"> –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</label>
      </div>
      <div class="field">
        <label>–û–∑–≤—É—á–∫–∞:</label>
        <select id="voiceSelect">
          <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
          <option value="male">–ú—É–∂—Å–∫–æ–π</option>
        </select>
      </div>
      <button id="clearBtn" style="padding:12px;background:#ff7b00;border:none;border-radius:10px;color:#001;font-weight:700;cursor:pointer">üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
    </aside>
  </div>

  <script>
    const API_URL = "https://openai-proxy-3.onrender.com/v1/responses";

    let chatHistory = JSON.parse(localStorage.getItem('sh_chatHistory') || '[]');
    let lastAI = "";
    let voicesList = [];
    let selectedVoiceGender = localStorage.getItem('sh_voice_gender') || 'female';

    const chatEl = document.getElementById('chat');

    function renderMessage(text, role) {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + role;
      const av = document.createElement('div'); av.className = 'avatar';
      const img = document.createElement('img');
      img.style.width = '54px'; img.style.height = '54px'; img.style.borderRadius = '50%';
      img.src = role === 'user'
        ? 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg"...`) // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–≤–∞—Ç–∞—Ä –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å
        : 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg"...`);
      av.appendChild(img);

      const bubble = document.createElement('div');
      bubble.className = 'bubble typing';
      bubble.textContent = '';
      wrap.appendChild(av);
      wrap.appendChild(bubble);
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;

      // –ü–µ—á–∞—Ç–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ –±—É–∫–≤–∞–º
      let i = 0;
      const interval = setInterval(() => {
        bubble.textContent += text.charAt(i);
        i++;
        if (i >= text.length) {
          clearInterval(interval);
          bubble.classList.remove('typing');
          bubble.classList.add('text-reveal');
        }
        chatEl.scrollTop = chatEl.scrollHeight;
      }, 30);
    }

    function saveChatHistory() {
      localStorage.setItem('sh_chatHistory', JSON.stringify(chatHistory));
    }

    function clearChat() {
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç?")) return;
      chatHistory = [];
      saveChatHistory();
      chatEl.innerHTML = '';
      lastAI = '';
    }

    function speakText(text) {
      if (!text) return;
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ru-RU';

      const pref = document.getElementById('voiceSelect').value;
      let voice = voicesList.find(v => {
        if (pref === 'male') return /male|man/i.test(v.name);
        else return /female|woman/i.test(v.name);
      }) || voicesList[0];
      if (voice) utter.voice = voice;

      localStorage.setItem('sh_voice_gender', pref);
      synth.cancel();
      synth.speak(utter);
    }

    function startSpeechToText() {
      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Rec) { alert("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è"); return; }
      const rec = new Rec();
      rec.lang = 'ru-RU';
      rec.onresult = e => {
        document.getElementById('userInput').value = e.results[0][0].transcript;
      };
      rec.start();
    }

    async function sendMessage(text) {
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ‚Äú–ø–µ—á–∞—Ç–∞–µ—Ç‚Äù placeholder
      renderMessage("...", "ai");
      try {
        const resp = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: "gpt-4o-mini", input: text })
        });
        const data = await resp.json();
        let answer = "";
        if (data.choices && data.choices[0]?.message?.content) {
          answer = data.choices[0].message.content;
        } else {
          answer = "–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞";
        }
        lastAI = answer;
        chatHistory.push({ role: "ai", text: answer });
        saveChatHistory();

        // —É–¥–∞–ª—è–µ–º placeholder –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        chatEl.removeChild(chatEl.lastChild);
        renderMessage(answer, "ai");
      } catch (err) {
        console.error(err);
        chatEl.removeChild(chatEl.lastChild);
        renderMessage("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", "ai");
      }
    }

    document.getElementById('sendBtn').addEventListener('click', () => {
      const txt = document.getElementById('userInput').value.trim();
      if (!txt) return;
      document.getElementById('userInput').value = "";
      chatHistory.push({ role: "user", text: txt });
      saveChatHistory();
      renderMessage(txt, "user");
      sendMessage(txt);
    });

    document.getElementById('micBtn').addEventListener('click', startSpeechToText);
    document.getElementById('speakBtn').addEventListener('click', () => speakText(lastAI));

    const themeSwitch = document.getElementById('themeSwitch');
    themeSwitch.addEventListener('change', () => {
      const on = themeSwitch.checked;
      document.body.classList.toggle("light", on);
      localStorage.setItem('sh_theme_is_light', on ? '1' : '0');
    });

    (function init(){
      chatHistory.forEach(msg => renderMessage(msg.text, msg.role));

      voicesList = window.speechSynthesis.getVoices();
      window.speechSynthesis.onvoiceschanged = () => {
        voicesList = window.speechSynthesis.getVoices();
      };

      const saved = localStorage.getItem('sh_theme_is_light') === '1';
      themeSwitch.checked = saved;
      document.body.classList.toggle("light", saved);

      const vsel = document.getElementById('voiceSelect');
      vsel.value = selectedVoiceGender;
    })();
  </script>
</body>
</html>
